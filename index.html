<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Making Suggestions</title>
    
    <style>
        :root {
            --primary-blue: #007bff;
            --dark-blue: #0056b3;
            --green: #28a745;
            --red: #dc3545;
            --yellow: #f0ad4e;
            
            --bg-color: #f0f4f8;
            --container-bg: #ffffff;
            --text-color: #333;
            --header-bg: linear-gradient(135deg, var(--primary-blue), var(--dark-blue));
            --tab-bg: #f1f1f1;
            --tab-active-bg: var(--primary-blue);
            --tab-text: #555;
            --tab-active-text: #ffffff;
            --border-color: #dee2e6;
            --light-gray-bg: #f8f9fa;

            /* Categor√≠as */
            --cat-soft: #6c757d;    /* Suave */
            --cat-advice: #17a2b8;  /* Consejo */
            --cat-urgent: #dc3545;  /* Urgente */
        }

        /* Modo Oscuro */
        body.dark-mode {
            --bg-color: #121212;
            --container-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --header-bg: #1e1e1e;
            --tab-bg: #333;
            --tab-active-bg: var(--primary-blue);
            --tab-text: #bbb;
            --tab-active-text: #ffffff;
            --border-color: #444;
            --light-gray-bg: #2a2a2a;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            max-width: 950px;
            margin: 0 auto;
            background-color: var(--container-bg);
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.07);
            overflow: hidden;
            transition: background-color 0.3s;
        }
        header {
            background: var(--header-bg);
            color: white;
            padding: 20px 35px;
            text-align: center;
            position: relative;
        }
        header h1 { margin: 0; font-size: 2.5em; }
        header p { font-size: 1.2em; opacity: 0.9; margin: 5px 0 0; }
        
        .header-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 10px;
        }
        .control-button {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
        }
        .control-button:hover { background: rgba(255,255,255,0.4); }

        /* Pesta√±as */
        .main-tab-nav {
            display: flex;
            background-color: var(--tab-bg);
            border-bottom: 3px solid var(--dark-blue);
            overflow-x: auto;
        }
        .main-tab-nav button {
            background-color: inherit; border: none; outline: none; cursor: pointer;
            padding: 18px 20px; transition: 0.3s; font-size: 1.1em;
            font-weight: bold; color: var(--tab-text); flex-grow: 1; white-space: nowrap;
        }
        .main-tab-nav button:hover { background-color: var(--border-color); }
        .main-tab-nav button.active { background-color: var(--tab-active-bg); color: var(--tab-active-text); }
        
        .main-tab-content { display: none; padding: 30px; }
        .main-tab-content.is-active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Estilos Generales */
        h2 { color: var(--primary-blue); border-bottom: 2px solid var(--primary-blue); padding-bottom: 5px; font-size: 1.8em; margin-top: 0; }
        h3 { color: var(--green); font-size: 1.4em; margin-top: 25px; }
        .accent { color: var(--primary-blue); font-weight: bold; }
        
        /* Grilla de 3 Columnas */
        .comparison-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 20px; 
        }
        @media (max-width: 768px) {
            .comparison-grid { grid-template-columns: 1fr; }
        }

        .tense-box { 
            background-color: var(--light-gray-bg); 
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            padding: 20px; 
            text-align: center; 
            min-height: 180px;
        }
        .tense-box[data-cat="soft"] { border-top: 5px solid var(--cat-soft); }
        .tense-box[data-cat="advice"] { border-top: 5px solid var(--cat-advice); }
        .tense-box[data-cat="urgent"] { border-top: 5px solid var(--cat-urgent); }

        .icon-wrapper { font-size: 4em; margin-bottom: 10px; display:block; }
        
        /* Video */
        .video-container {
            position: relative; width: 100%; padding-bottom: 56.25%; height: 0;
            overflow: hidden; border-radius: 8px; background: #000; margin-top: 20px; border: 1px solid var(--border-color);
        }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }

        /* Formula Visualizer */
        .formula-visualizer {
            background-color: var(--light-gray-bg); border: 1px solid var(--border-color);
            border-radius: 8px; padding: 20px; margin-top: 20px;
        }
        .formula-controls { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .formula-toggle {
            padding: 10px 18px; border-radius: 8px; font-weight: bold; font-size: 1.1em;
            cursor: pointer; background: var(--container-bg); border: 2px solid #ccc;
            transition: all 0.2s;
        }
        .formula-toggle.active {
            color: white; transform: scale(1.05); box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .ft-inf.active { background: var(--green); border-color: var(--green); }
        .ft-subj.active { background: var(--red); border-color: var(--red); }
        
        .formula-result { 
            min-height: 100px; padding: 15px; background: var(--container-bg); border-radius: 8px; 
            border: 2px solid var(--border-color); display: flex; align-items: center; justify-content: center;
            font-size: 1.3em; text-align: center; font-weight: 500;
        }
        .formula-card {
            padding: 8px 12px; border-radius: 6px; font-weight: bold;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: inline-block; margin: 0 5px;
        }
        .fc-subj { background: #f8d7da; color: var(--red); border: 1px solid var(--red); }
        .fc-inf { background: #d4edda; color: var(--green); border: 1px solid var(--green); }
        .fc-trigger { background: #cce5ff; color: var(--primary-blue); border: 1px solid var(--primary-blue); }
        .fc-que { background: #fff3cd; color: #856404; border: 1px solid var(--yellow); }

        /* Phrase Bank */
        .bank-controls { 
            display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; 
            background: var(--light-gray-bg); padding: 15px; border-radius: 8px; 
            border: 1px solid var(--border-color); flex-wrap: wrap;
        }
        .bank-controls .filter-btn {
            padding: 8px 12px; border: 2px solid transparent; border-radius: 6px;
            font-weight: bold; cursor: pointer; transition: background 0.2s; font-size: 0.9em;
            background: var(--container-bg);
        }
        .bank-controls .filter-btn[data-cat="soft"] { color: var(--cat-soft); border-color: var(--cat-soft); }
        .bank-controls .filter-btn[data-cat="advice"] { color: var(--cat-advice); border-color: var(--cat-advice); }
        .bank-controls .filter-btn[data-cat="urgent"] { color: var(--cat-urgent); border-color: var(--cat-urgent); }

        .bank-controls .filter-btn.active { color: white; filter: brightness(1.2); }
        .bank-controls .filter-btn[data-cat="soft"].active { background: var(--cat-soft); }
        .bank-controls .filter-btn[data-cat="advice"].active { background: var(--cat-advice); }
        .bank-controls .filter-btn[data-cat="urgent"].active { background: var(--cat-urgent); }

        .verb-card { 
            background: var(--container-bg); border: 1px solid var(--border-color); 
            border-radius: 10px; padding: 15px; margin-bottom: 15px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: transform 0.2s; 
        }
        .verb-card[data-cat="soft"] { border-left: 5px solid var(--cat-soft); }
        .verb-card[data-cat="advice"] { border-left: 5px solid var(--cat-advice); }
        .verb-card[data-cat="urgent"] { border-left: 5px solid var(--cat-urgent); }
        
        .verb-card:hover { transform: translateY(-3px); }
        .verb-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 10px; }
        .verb-title { font-size: 1.3em; font-weight: bold; color: var(--primary-blue); }
        .btn-explain { background: var(--yellow); color: #333; border: none; padding: 3px 10px; border-radius: 15px; font-size: 0.8em; cursor: pointer; font-weight: bold; margin-left: 10px; }
        .tts-icon { cursor: pointer; margin-left: 5px; opacity: 0.8; }

        /* Modal */
        #explain-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 1000; display: none;
            justify-content: center; align-items: center;
        }
        .modal-content {
            background: var(--container-bg); padding: 30px; border-radius: 15px;
            max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;
            border: 2px solid var(--primary-blue); position: relative;
        }
        .modal-close { position: absolute; top: 15px; right: 15px; font-size: 1.5em; cursor: pointer; }
        .explain-block { margin-bottom: 20px; border-left: 4px solid var(--border-color); padding-left: 15px; }

        /* Quiz & Practice */
        .instruction-box { background-color: #e2e6ea; border-left: 5px solid var(--primary-blue); padding: 15px; margin-bottom: 20px; border-radius: 4px; font-style: italic; color: #555; }
        .quiz-section { margin-bottom: 25px; padding-bottom: 25px; border-bottom: 2px dashed var(--border-color); }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .refresh-btn { font-size: 0.9em; padding: 5px 10px; background-color: var(--primary-blue); color: white; border:none; border-radius: 4px; cursor: pointer;}
        .button-secondary { background-color: transparent; border: 1px solid var(--primary-blue); color: var(--primary-blue); }
        .button-primary { background-color: var(--primary-blue); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }

        .quiz-question { margin-bottom: 15px; background: var(--light-gray-bg); padding: 15px; border-radius: 5px; }
        .quiz-question button { 
            background-color: var(--container-bg); border: 1px solid var(--primary-blue); 
            color: var(--primary-blue); padding: 8px 15px; margin-right: 10px; margin-top: 5px;
            border-radius: 5px; cursor: pointer;
        }
        .feedback { font-weight: bold; margin-left: 10px; }
        .correct { color: var(--green); } .incorrect { color: var(--red); }
        .explanation-text { font-size: 0.9em; color: #555; margin-top: 10px; padding: 8px; background: #e9ecef; border-radius: 4px; }
        .story-translation { display: block; font-style: italic; color: #666; font-size: 0.9em; margin-top: 5px; margin-bottom: 15px; border-left: 3px solid #ddd; padding-left: 10px; }

        /* Story */
        .interactive-story { background: #fffbe6; border: 1px solid #ffe58f; padding: 20px; border-radius: 8px; font-size: 1.1em; line-height: 2; }
        .interactive-story select { padding: 2px 5px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; }
        body.dark-mode .interactive-story { background: #2c2c20; border-color: #444; color: #eee; }

        /* Drag Drop */
        .sorter-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .dropzone { min-height: 200px; background: var(--light-gray-bg); border: 3px dashed var(--border-color); border-radius: 8px; padding: 10px; }
        .dropzone h4 { text-align: center; margin-top: 0; }
        .draggable { 
            background-color: var(--container-bg); border: 1px solid #ccc; 
            padding: 10px; margin-bottom: 8px; border-radius: 5px; cursor: pointer; 
            display: inline-block; margin-right: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .draggable.selected { border: 2px solid var(--primary-blue); background-color: #e6f7ff; }

        /* Flashcards */
        .flashcard-app { display: flex; flex-direction: column; align-items: center; }
        .flashcard-container { width: 90%; max-width: 500px; height: 300px; perspective: 1000px; margin-bottom: 30px; }
        .flashcard { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.6s; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-radius: 10px; }
        .flashcard.is-flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; border-radius: 10px; box-sizing: border-box; font-size: 1.4em; }
        .card-front { background: var(--container-bg); border: 2px solid var(--primary-blue); }
        .card-back { background: var(--light-gray-bg); border: 2px solid var(--green); color: var(--dark-blue); transform: rotateY(180deg); }
        
        .big-emoji { font-size: 3.5rem; display: block; margin-bottom: 10px; }
    </style>
</head>
<body class="">

    <div class="container">
        <header>
            <div class="header-controls">
                <button class="control-button" onclick="toggleLang()" id="btn-lang">EN / ES</button>
                <button class="control-button" onclick="toggleTheme()">‚òÄÔ∏è/üåô</button>
            </div>
            <h1 data-lang-key="header_title">Making Suggestions</h1>
            <p data-lang-key="header_subtitle">Mastering Advice & Recommendations</p>
        </header>
        
        <nav class="main-tab-nav">
            <button class="main-tab-link active" onclick="changeMainTab(event, 'tab-metaphor')" data-lang-key="tab_1">üå°Ô∏è The Concept</button>
            <button class="main-tab-link" onclick="changeMainTab(event, 'tab-formacion')" data-lang-key="tab_2">‚úçÔ∏è The Formula</button>
            <button class="main-tab-link" onclick="changeMainTab(event, 'tab-bank')" data-lang-key="tab_bank">üìö Phrase Bank</button>
            <button class="main-tab-link" onclick="changeMainTab(event, 'tab-practica')" data-lang-key="tab_3">üß† Interactive Practice</button>
            <button class="main-tab-link" onclick="changeMainTab(event, 'tab-flashcards')" data-lang-key="tab_4">üìá Flashcards</button>
        </nav>

        <main>
            <div id="tab-metaphor" class="main-tab-content is-active">
                <h2 data-lang-key="metaphor_title">Suggestion Intensity Levels</h2>
                
                <div class="comparison-grid">
                    <div class="tense-box" data-cat="soft">
                        <span class="icon-wrapper" style="color: var(--cat-soft);">üßò</span>
                        <h3 style="color: var(--cat-soft);" data-lang-key="soft_title">Soft (Suave)</h3>
                        <p data-lang-key="soft_desc">Friendly suggestion. Usually uses <strong>Infinitive</strong> or **Conditional**.</p>
                        <p><em>"Podr√≠as... / Yo en tu lugar..."</em></p>
                    </div>
                    <div class="tense-box" data-cat="advice">
                        <span class="icon-wrapper" style="color: var(--cat-advice);">üó£Ô∏è</span>
                        <h3 style="color: var(--cat-advice);" data-lang-key="advice_title">Advice (Consejo)</h3>
                        <p data-lang-key="advice_desc">Direct recommendation. Needs <strong>Subjunctive</strong> if the subject changes.</p>
                        <p><em>"Te aconsejo que... / Sugiero que..."</em></p>
                    </div>
                    <div class="tense-box" data-cat="urgent">
                        <span class="icon-wrapper" style="color: var(--cat-urgent);">üö®</span>
                        <h3 style="color: var(--cat-urgent);" data-lang-key="urgent_title">Urgent (Necesario)</h3>
                        <p data-lang-key="urgent_desc">Strong necessity. Always triggers <strong>Subjunctive</strong> (when using 'que').</p>
                        <p><em>"Es crucial que... / Es vital que..."</em></p>
                    </div>
                </div>

                <h3 style="margin-top: 30px;" data-lang-key="video_title">Video Tutorial</h3>
                <div class="video-container">
                    <iframe src="https://drive.google.com/file/d/1qHOThlaPG9sPwqGWjrvzOcphqbKsr4Cy/preview" allow="autoplay"></iframe>
                </div>

                <h3 style="margin-top: 30px;" data-lang-key="viz_title">Interactive Formula</h3>
                <div class="formula-visualizer">
                    <p data-lang-key="viz_desc">Select a grammar structure.</p>
                    <div class="formula-controls">
                        <div class="formula-toggle ft-inf active" data-type="inf" onclick="showViz(this, 'Podr√≠as...', 'al parque a', 'ir', '(Infinitive)')">Infinitive Form (Same Subject)</div>
                        <div class="formula-toggle ft-subj" data-type="subj" onclick="showViz(this, 'Te aconsejo', 'que + t√∫', 'revises', '(Subjunctive)')">Subjunctive Form (Subject Change)</div>
                    </div>
                    <div id="viz-result" class="formula-result">
                        <div class='formula-card fc-trigger'>Podr√≠as...</div> al parque a <div class='formula-card fc-inf'>ir</div> (Infinitive)
                    </div>
                </div>
            </div>

            <div id="tab-formacion" class="main-tab-content">
                <h2 data-lang-key="form_title">The Structure</h2>
                <div class="comparison-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="tense-box">
                        <span class="big-emoji">üë§ ‚û° üë§</span>
                        <h3 style="color: var(--green);">1. Infinitive</h3>
                        <p data-lang-key="inf_rule">Use when there is **no change of subject** (The person giving advice is included or it's general).</p>
                        <p class="formula-card fc-inf">Trigger + Infinitive</p>
                        <p data-lang-key="inf_ex_es">Ej: "Debes <strong class="accent">comer</strong> m√°s."</p>
                    </div>
                    <div class="tense-box">
                        <span class="big-emoji">üë§ ‚û° üëΩ</span>
                        <h3 style="color: var(--red);">2. Subjunctive</h3>
                        <p data-lang-key="subj_rule">Use when you want **someone else** to do something (Subject Change).</p>
                        <p class="formula-card fc-subj">Trigger + QUE + Subjunctive</p>
                        <p data-lang-key="subj_ex_es">Ej: "Te aconsejo que <strong class="accent">comas</strong> m√°s."</p>
                    </div>
                </div>
            </div>

            <div id="tab-bank" class="main-tab-content">
                <h2 data-lang-key="bank_title">Phrase Bank</h2>
                <div class="bank-controls">
                    <label style="font-weight:bold; margin-right: 10px;" data-lang-key="label_filter">Filter:</label>
                    <button class="filter-btn active" data-cat="all" onclick="filterBank(this, 'all')" data-lang-key="btn_all">All</button>
                    <button class="filter-btn" data-cat="soft" onclick="filterBank(this, 'soft')" data-lang-key="btn_soft">Soft</button>
                    <button class="filter-btn" data-cat="advice" onclick="filterBank(this, 'advice')" data-lang-key="btn_advice">Advice</button>
                    <button class="filter-btn" data-cat="urgent" onclick="filterBank(this, 'urgent')" data-lang-key="btn_urgent">Urgent</button>
                </div>
                <div id="bankContainer"></div>
            </div>

            <div id="explain-modal">
                <div class="modal-content">
                    <span class="modal-close" onclick="closeModal()">&times;</span>
                    <h2 id="modal-title">Title</h2>
                    <div class="explain-block">
                        <h4 data-lang-key="modal_struct_title">Structure</h4>
                        <p class="explain-label" id="modal-struct">-</p>
                    </div>
                    <div class="explain-block">
                        <h4 data-lang-key="modal_context_title">Contextual Example</h4>
                        <p class="explain-label" id="modal-ex-es" style="font-weight:bold; margin-bottom:5px;">-</p>
                        <p class="explain-label" id="modal-ex-en" style="font-style:italic; color:#555;">-</p>
                    </div>
                    <button class="refresh-btn" onclick="closeModal()" data-lang-key="btn_close">Close</button>
                </div>
            </div>

            <div id="tab-practica" class="main-tab-content">
                <h2 data-lang-key="practice_main_title">Interactive Practice</h2>
                
                <div class="quiz-section">
                    <div class="section-header">
                        <h3 data-lang-key="quiz_title">Part 1: Quick Quiz</h3>
                        <button id="generate-quiz" class="refresh-btn button-secondary" data-lang-key="btn_new">New Quiz</button>
                    </div>
                    <div class="instruction-box">
                        <strong>Instructions:</strong> Read the sentence carefully and choose the correct form of the verb (Infinitive or Subjunctive). Pay attention to whether the subject changes! üßê
                    </div>
                    <div id="quiz-container"></div>
                </div>

                <div class="quiz-section">
                    <div class="section-header">
                        <h3 data-lang-key="story_title">Part 2: Advice Story</h3>
                        <button id="generate-story" class="refresh-btn button-secondary" data-lang-key="btn_new_story">New Story</button>
                    </div>
                    <div class="instruction-box">
                        <strong>Instructions:</strong> Complete the story by selecting the correct verb conjugation from the dropdown menus based on the context. üìñ
                    </div>
                    <div id="story-container" class="interactive-story"></div>
                    <button id="check-story-btn" class="button-primary" style="margin-top: 20px;" data-lang-key="btn_check">Check Story</button>
                </div>

                <div class="quiz-section">
                    <div class="section-header">
                        <h3 data-lang-key="drag_title">Part 3: Structure Sorter</h3>
                        <button id="generate-drag" class="refresh-btn button-secondary" data-lang-key="btn_new_match">Reset</button>
                    </div>
                    <div class="instruction-box">
                        <strong>Instructions:</strong> Click on a phrase to select it, then click on the correct box (Infinitive or Subjunctive) to sort it. üß©
                    </div>
                    <div id="items-to-sort">
                        <div id="drag-items-pool"></div>
                    </div>
                    <div class="sorter-container">
                        <div class="dropzone" id="zone-inf" onclick="handleDrop('inf')"><h4 style="color: var(--green);">+ Infinitive</h4><div class="zone-content"></div></div>
                        <div class="dropzone" id="zone-subj" onclick="handleDrop('subj')"><h4 style="color: var(--red);">+ Subjunctive</h4><div class="zone-content"></div></div>
                    </div>
                    <div id="drag-feedback" class="feedback" style="margin-top:10px;"></div>
                </div>
            </div>

            <div id="tab-flashcards" class="main-tab-content">
                <h2>Flashcards</h2>
                <div class="flashcard-app">
                    <div class="flashcard-container">
                        <div class="flashcard" id="flashcard">
                            <div class="card-face card-front" id="card-front"></div>
                            <div class="card-face card-back" id="card-back"></div>
                        </div>
                    </div>
                    <div class="flashcard-nav">
                        <button onclick="prevCard()" class="button-secondary" data-lang-key="btn_prev">Previous</button>
                        <button onclick="flipCard()" class="button-primary" data-lang-key="btn_flip">Flip</button>
                        <button onclick="nextCard()" class="button-secondary" data-lang-key="btn_next">Next</button>
                    </div>
                </div>
            </div>

        </main>
    </div>

<script>

// --- DATA ---
const uiData = {
    en: {
        header_title: "Making Suggestions", header_subtitle: "Advice & Recommendations",
        tab_1: "üå°Ô∏è The Concept", tab_2: "‚úçÔ∏è The Formula", tab_bank: "üìö Phrase Bank", tab_3: "üß† Interactive Practice", tab_4: "üìá Flashcards",
        soft_title: "Soft", soft_desc: "Friendly suggestion. Uses Infinitive or Conditional.",
        advice_title: "Advice", advice_desc: "Direct recommendation. Uses Subjunctive if subject changes.",
        urgent_title: "Strong Necessity", urgent_desc: "Strong recommendation. Triggers Subjunctive.",
        viz_title: "Interactive Formula", viz_desc: "Select a grammar structure.",
        form_title: "The Structure", 
        inf_rule: "Use when there is **no change of subject**.", inf_ex_es: 'Ej: "Debes <strong class="accent">comer</strong> m√°s."',
        subj_rule: "Use when you want **someone else** to do something.", subj_ex_es: 'Ej: "Te aconsejo que <strong class="accent">comas</strong> m√°s."',
        bank_title: "Phrase Bank", btn_all: "All", btn_soft: "Soft", btn_advice: "Advice", btn_urgent: "Urgent",
        modal_struct_title: "Structure", modal_context_title: "Contextual Example", btn_close: "Close",
        practice_main_title: "Interactive Practice", quiz_title: "Part 1: Quick Quiz", btn_new: "New Quiz",
        story_title: "Part 2: Advice Story", btn_new_story: "New Story", btn_check: "Check",
        drag_title: "Part 3: Structure Sorter", btn_new_match: "Reset", drag_desc: "Click a phrase, then click the correct box.",
        btn_prev: "Prev", btn_flip: "Flip", btn_next: "Next"
    },
    es: {
        header_title: "Hacer Sugerencias", header_subtitle: "Consejos y Recomendaciones",
        tab_1: "üå°Ô∏è El Concepto", tab_2: "‚úçÔ∏è La F√≥rmula", tab_bank: "üìö Banco de Frases", tab_3: "üß† Pr√°ctica Interactiva", tab_4: "üìá Tarjetas",
        soft_title: "Suave", soft_desc: "Sugerencia amistosa. Usa Infinitivo o Condicional.",
        advice_title: "Consejo", advice_desc: "Recomendaci√≥n directa. Usa Subjuntivo si cambia el sujeto.",
        urgent_title: "Necesidad Fuerte", urgent_desc: "Recomendaci√≥n muy fuerte. Activa Subjuntivo.",
        viz_title: "F√≥rmula Interactiva", viz_desc: "Selecciona una estructura gramatical.",
        form_title: "La Estructura", 
        inf_rule: "Se usa cuando **no hay cambio de sujeto**.", inf_ex_es: 'Ej: "Debes <strong class="accent">comer</strong> m√°s."',
        subj_rule: "Se usa cuando quieres que **otra persona** haga algo.", subj_ex_es: 'Ej: "Te aconsejo que <strong class="accent">comas</strong> m√°s."',
        bank_title: "Banco de Frases", btn_all: "Todas", btn_soft: "Suave", btn_advice: "Consejo", btn_urgent: "Urgente",
        modal_struct_title: "Estructura", modal_context_title: "Ejemplo Contextual", btn_close: "Cerrar",
        practice_main_title: "Pr√°ctica Interactiva", quiz_title: "Parte 1: Quiz R√°pido", btn_new: "Nuevo Quiz",
        story_title: "Parte 2: Historia de Consejos", btn_new_story: "Nueva Historia", btn_check: "Verificar",
        drag_title: "Parte 3: Clasificador", btn_new_match: "Reiniciar", drag_desc: "Haz clic en la frase, luego en la caja correcta.",
        btn_prev: "Ant", btn_flip: "Voltear", btn_next: "Sig"
    }
};

// PHRASE BANK CON ORACIONES LARGAS Y CONTEXTUALES
const phraseBankData = [
    { text: "Podr√≠as...", cat: "soft", struct: "Infinitive", ex_es: "Si est√°s aburrido en casa, podr√≠as salir a caminar por el parque.", ex_en: "If you are bored at home, you could go out for a walk in the park." },
    { text: "Deber√≠as...", cat: "soft", struct: "Infinitive", ex_es: "Est√°s tosiendo mucho; deber√≠as ir al m√©dico para que te revise.", ex_en: "You are coughing a lot; you should go to the doctor to get checked." },
    { text: "Yo en tu lugar...", cat: "soft", struct: "Conditional", ex_es: "Yo en tu lugar, no gastar√≠a tanto dinero en ropa que no necesito.", ex_en: "If I were you, I wouldn't spend so much money on clothes I don't need." },
    { text: "Te aconsejo que...", cat: "advice", struct: "Subjunctive", ex_es: "Te aconsejo que llegues temprano al aeropuerto para evitar problemas.", ex_en: "I advise you to arrive early at the airport to avoid problems." },
    { text: "Te recomiendo que...", cat: "advice", struct: "Subjunctive", ex_es: "Te recomiendo que pruebes la paella de este restaurante, es deliciosa.", ex_en: "I recommend that you try the paella at this restaurant, it is delicious." },
    { text: "Sugiero que...", cat: "advice", struct: "Subjunctive", ex_es: "Sugiero que estudiemos juntos para el examen final de historia.", ex_en: "I suggest that we study together for the final history exam." },
    { text: "Es mejor que...", cat: "advice", struct: "Subjunctive", ex_es: "Es mejor que lleves un paraguas porque el cielo est√° muy gris.", ex_en: "It's better that you take an umbrella because the sky is very gray." },
    { text: "Es crucial que...", cat: "urgent", struct: "Subjunctive", ex_es: "Es crucial que termines el informe antes de la reuni√≥n con el cliente.", ex_en: "It is crucial that you finish the report before the meeting with the client." },
    { text: "Es urgente que...", cat: "urgent", struct: "Subjunctive", ex_es: "Es urgente que llames a tu madre, parece que ha ocurrido algo.", ex_en: "It is urgent that you call your mother, it seems something has happened." },
    { text: "Es vital que...", cat: "urgent", struct: "Subjunctive", ex_es: "Para tu recuperaci√≥n, es vital que sigas todas las instrucciones del doctor.", ex_en: "For your recovery, it is vital that you follow all the doctor's instructions." }
];

// QUIZ CON ORACIONES LARGAS Y CONTEXTO
const quizItems = [
    { q: "Tu amigo tiene mucho sue√±o en el trabajo. Te recomiendo que (dormir) ocho horas diarias. üò¥", context_en: "Recommendation for someone else. (I recommend that you sleep 8 hours daily.)", options: ["duermas", "dormir"], correct: 0, exp: "Recomiendo que -> Subjuntivo." },
    { q: "Te sientes enfermo y con fiebre. Deber√≠as (ir) al hospital inmediatamente. ü§í", context_en: "Soft suggestion directed at you. (You should go to the hospital immediately.)", options: ["vayas", "ir"], correct: 1, exp: "Deber√≠as -> Infinitivo." },
    { q: "Para entender bien este tema, es fundamental que t√∫ (prestar) mucha atenci√≥n en clase. üí°", context_en: "Strong necessity with specific subject. (It is fundamental that you pay attention.)", options: ["prestes", "prestar"], correct: 0, exp: "Es fundamental que -> Subjuntivo." },
    { q: "Si quieres mejorar tu ingl√©s, podr√≠as (ver) pel√≠culas sin subt√≠tulos. üì∫", context_en: "Soft suggestion. (You could watch movies without subtitles.)", options: ["veas", "ver"], correct: 1, exp: "Podr√≠as -> Infinitivo." },
    { q: "El tr√°fico est√° terrible hoy. Sugiero que nosotros (tomar) el metro para llegar a tiempo. üöá", context_en: "Suggestion for a group. (I suggest that we take the subway.)", options: ["tomemos", "tomar"], correct: 0, exp: "Sugerir que -> Subjuntivo." },
    { q: "Es vital que t√∫ (enviar) los documentos antes de las 5:00 PM. ‚è∞", context_en: "Strong requirement. (It is vital that you send the documents.)", options: ["env√≠es", "enviar"], correct: 0, exp: "Es vital que -> Subjuntivo." },
    { q: "Ese coche es muy caro. Yo en tu lugar (buscar) una opci√≥n m√°s econ√≥mica. üöó", context_en: "Conditional advice. (If I were you, I would look for a cheaper option.)", options: ["busque", "buscar√≠a"], correct: 1, exp: "Yo en tu lugar -> Condicional." },
    { q: "Es malo para tu salud. Te aconsejo que no (comer) tanta comida r√°pida. üçî", context_en: "Advice against something. (I advise you not to eat so much fast food.)", options: ["comas", "comer"], correct: 0, exp: "Aconsejo que -> Subjuntivo." },
    { q: "Est√° lloviendo mucho. Es mejor que t√∫ (esperar) a que pase la tormenta. üåßÔ∏è", context_en: "Specific subject warning. (It is better that you wait for the storm to pass.)", options: ["esperes", "esperar"], correct: 0, exp: "Es mejor que -> Subjuntivo." },
    { q: "Para tener una vida sana, ser√≠a bueno (hacer) ejercicio tres veces por semana. üèÉ", context_en: "General idea/No specific subject. (It would be good to exercise.)", options: ["hagas", "hacer"], correct: 1, exp: "Ser√≠a bueno (general) -> Infinitivo." },
    { q: "Tu hermana est√° preocupada. Es urgente que la (llamar) ahora mismo. üìû", context_en: "Urgent request. (It is urgent that you call her right now.)", options: ["llames", "llamar"], correct: 0, exp: "Es urgente que -> Subjuntivo." },
    { q: "Esta serie es fant√°stica. Te recomiendo (ver) el primer episodio hoy. üé¨", context_en: "Direct recommendation without 'que'. (I recommend watching the first episode.)", options: ["veas", "ver"], correct: 1, exp: "Te recomiendo (sin que) -> Infinitivo." },
    { q: "No me gusta este hotel. Sugiero que (buscar) otro lugar para dormir. üè®", context_en: "Specific suggestion. (I suggest that we/you look for another place.)", options: ["busquemos", "buscar"], correct: 0, exp: "Sugiero que -> Subjuntivo." },
    { q: "El proyecto est√° atrasado. Es crucial que el equipo (trabajar) este fin de semana. üèóÔ∏è", context_en: "Crucial requirement for the team. (It is crucial that the team works.)", options: ["trabaje", "trabajar"], correct: 0, exp: "Es crucial que -> Subjuntivo." },
    { q: "Si no sabes la respuesta, podr√≠as (preguntar) al profesor. üôã", context_en: "Soft suggestion. (You could ask the teacher.)", options: ["preguntar", "preguntes"], correct: 0, exp: "Podr√≠as -> Infinitivo." },
    { q: "Hay mucho ruido aqu√≠. Te sugiero que (ir) a la biblioteca para estudiar. üìö", context_en: "Subject change. (I suggest that you go to the library.)", options: ["vayas", "ir"], correct: 0, exp: "Sugiero que -> Subjuntivo." },
    { q: "Quieres comprar una casa. Deber√≠as (ahorrar) m√°s dinero cada mes. üí∞", context_en: "Advice. (You should save more money every month.)", options: ["ahorrar", "ahorres"], correct: 0, exp: "Deber√≠as -> Infinitivo." },
    { q: "Es una reuni√≥n familiar. Es importante que nosotros (asistir). üë®‚Äçüë©‚Äçüëß‚Äçüë¶", context_en: "Important for us. (It is important that we attend.)", options: ["asistamos", "asistir"], correct: 0, exp: "Es importante que -> Subjuntivo." },
    { q: "Tienes mucha sed. Te aconsejo (beber) un vaso de agua fr√≠a. üíß", context_en: "Simple advice/Same subject implied. (I advise drinking a glass of water.)", options: ["bebas", "beber"], correct: 1, exp: "Te aconsejo (sin que) -> Infinitivo." },
    { q: "Hace mucho fr√≠o fuera. Es mejor que no (salir) sin tu abrigo. ‚ùÑÔ∏è", context_en: "Warning. (It is better that you do not go out without your coat.)", options: ["salgas", "salir"], correct: 0, exp: "Es mejor que -> Subjuntivo." }
];

// HISTORIAS LARGAS CON TRADUCCI√ìN
const storyData = [
    { title: "Trip to Peru üáµüá™", html: `<p>1. Te das cuenta de que Juan no tiene su documento. <br> "Juan, es urgente que <select><option value='x'>sacar</option><option value='c'>saques</option></select> tu pasaporte inmediatamente." <span class="story-translation">Juan, it is urgent that you get your passport immediately.</span></p><p>2. El clima en los Andes es muy variable. <br> "Yo en tu lugar <select><option value='c'>llevar√≠a</option><option value='x'>lleve</option></select> mucha ropa de abrigo." <span class="story-translation">If I were you, I would take a lot of warm clothes.</span></p>` },
    { title: "Job Interview üíº", html: `<p>1. Mar√≠a est√° muy nerviosa por su entrevista de ma√±ana. <br> "Podr√≠as <select><option value='c'>practicar</option><option value='x'>practiques</option></select> tus respuestas frente al espejo." <span class="story-translation">You could practice your answers in front of the mirror.</span></p><p>2. Ella no sabe qu√© ropa ponerse. <br> "Te aconsejo que <select><option value='c'>vistas</option><option value='x'>vestir</option></select> de manera formal y elegante." <span class="story-translation">I advise you to dress formally and elegantly.</span></p>` },
    { title: "Feeling Sick ü§í", html: `<p>1. Tienes fiebre y te duele mucho la cabeza. <br> "Deber√≠as <select><option value='c'>descansar</option><option value='x'>descanses</option></select> en casa hoy y no ir a trabajar." <span class="story-translation">You should rest at home today and not go to work.</span></p><p>2. Los s√≠ntomas no mejoran despu√©s de dos d√≠as. <br> "Es vital que <select><option value='x'>ir</option><option value='c'>vayas</option></select> a la cl√≠nica ahora mismo." <span class="story-translation">It is vital that you go to the clinic right now.</span></p>` },
    { title: "Broken Laptop üíª", html: `<p>1. La pantalla de tu ordenador se ha quedado negra. <br> "Sugiero que <select><option value='c'>reinicies</option><option value='x'>reiniciar</option></select> el sistema para ver si reacciona." <span class="story-translation">I suggest that you restart the system to see if it reacts.</span></p><p>2. El problema persiste y necesitas trabajar. <br> "Es mejor que <select><option value='c'>llames</option><option value='x'>llamar</option></select> al soporte t√©cnico especializado." <span class="story-translation">It is better that you call specialized technical support.</span></p>` },
    { title: "Learning Spanish üá™üá∏", html: `<p>1. Quieres mejorar tu vocabulario r√°pidamente. <br> "Te recomiendo que <select><option value='c'>leas</option><option value='x'>leer</option></select> novelas cortas en espa√±ol." <span class="story-translation">I recommend that you read short novels in Spanish.</span></p><p>2. Te aburres estudiando gram√°tica solamente. <br> "Podr√≠as <select><option value='c'>ver</option><option value='x'>veas</option></select> series latinas para divertirte mientras aprendes." <span class="story-translation">You could watch Latin series to have fun while you learn.</span></p>` },
    { title: "Buying a Car üöó", html: `<p>1. Tienes un presupuesto muy limitado para el coche. <br> "Es importante que <select><option value='c'>compares</option><option value='x'>comparar</option></select> precios en diferentes concesionarios." <span class="story-translation">It is important that you compare prices at different dealerships.</span></p><p>2. No est√°s seguro del estado del motor. <br> "Yo en tu lugar <select><option value='c'>probar√≠a</option><option value='x'>pruebe</option></select> el coche con un mec√°nico de confianza." <span class="story-translation">If I were you, I would test the car with a trusted mechanic.</span></p>` },
    { title: "Cooking Dinner üçù", html: `<p>1. La salsa de tomate est√° demasiado √°cida. <br> "Podr√≠as <select><option value='c'>a√±adir</option><option value='x'>a√±adas</option></select> una cucharadita de az√∫car para corregirlo." <span class="story-translation">You could add a teaspoon of sugar to correct it.</span></p><p>2. La pasta se est√° cocinando muy r√°pido. <br> "Te aconsejo que no la <select><option value='c'>cocines</option><option value='x'>cocinar</option></select> m√°s de ocho minutos." <span class="story-translation">I advise you not to cook it for more than eight minutes.</span></p>` },
    { title: "Fitness Goals üí™", html: `<p>1. Quieres correr un marat√≥n el pr√≥ximo a√±o. <br> "Es crucial que <select><option value='c'>seas</option><option value='x'>ser</option></select> constante con tus entrenamientos diarios." <span class="story-translation">It is crucial that you be consistent with your daily workouts.</span></p><p>2. Tu dieta actual no es muy saludable. <br> "Sugiero que <select><option value='c'>comas</option><option value='x'>comer</option></select> m√°s prote√≠nas y verduras." <span class="story-translation">I suggest that you eat more proteins and vegetables.</span></p>` },
    { title: "Relationship Problems üíî", html: `<p>1. Tienes problemas de comunicaci√≥n con tu pareja. <br> "Es vital que <select><option value='c'>hables</option><option value='x'>hablar</option></select> con total honestidad sobre tus sentimientos." <span class="story-translation">It is vital that you speak with total honesty about your feelings.</span></p><p>2. Sientes que necesitas un poco de espacio. <br> "Deber√≠as <select><option value='c'>pedir</option><option value='x'>pidas</option></select> un tiempo para reflexionar a solas." <span class="story-translation">You should ask for some time to reflect alone.</span></p>` },
    { title: "Saving Money üí∏", html: `<p>1. Gastas mucho dinero en cosas innecesarias cada mes. <br> "Te recomiendo que no <select><option value='c'>gastes</option><option value='x'>gastar</option></select> en lujos hasta pagar tus deudas." <span class="story-translation">I recommend that you do not spend on luxuries until you pay your debts.</span></p><p>2. Quieres comprar una casa en el futuro. <br> "Es mejor que <select><option value='c'>empieces</option><option value='x'>empezar</option></select> a ahorrar un 20% de tu sueldo hoy." <span class="story-translation">It is better that you start saving 20% of your salary today.</span></p>` }
];

// DRAG ITEMS (20 ITEMS)
const dragItemsData = [
    { text: "Podr√≠as...", type: "inf" },
    { text: "Te aconsejo que...", type: "subj" },
    { text: "Deber√≠as...", type: "inf" },
    { text: "Es vital que...", type: "subj" },
    { text: "Sugiero que...", type: "subj" },
    { text: "Ser√≠a bueno...", type: "inf" },
    { text: "Es crucial que...", type: "subj" },
    { text: "Yo en tu lugar...", type: "inf" },
    { text: "Te recomiendo que...", type: "subj" },
    { text: "Es mejor que...", type: "subj" },
    { text: "Es urgente que...", type: "subj" },
    { text: "Es importante que...", type: "subj" },
    { text: "Te sugiero...", type: "inf" },
    { text: "Te recomiendo...", type: "inf" },
    { text: "Te aconsejo...", type: "inf" },
    { text: "Para mejorar...", type: "inf" },
    { text: "Antes de salir...", type: "inf" },
    { text: "Es fundamental que...", type: "subj" },
    { text: "Es bueno...", type: "inf" },
    { text: "Es l√≥gico que...", type: "subj" }
];

// FLASHCARDS COMPLEJAS
const flashcards = [
    {en: "You look really exhausted; you should talk to your boss about taking a few days off.", es: "Te ves realmente agotado; <strong>deber√≠as hablar</strong> con tu jefe sobre tomarte unos d√≠as libres.", explanation: "Uso de 'Deber√≠as' + Infinitivo (Sugerencia suave al mismo sujeto)."},
    {en: "To avoid any legal issues, I advise you to read the contract carefully before signing.", es: "Para evitar problemas legales, <strong>te aconsejo que leas</strong> el contrato cuidadosamente antes de firmar.", explanation: "Uso de 'Aconsejo que' + Subjuntivo (Cambio de sujeto: Yo aconsejo -> T√∫ lees)."},
    {en: "The patient is in critical condition; it is crucial that the doctor operates immediately.", es: "El paciente est√° en estado cr√≠tico; <strong>es crucial que el doctor opere</strong> inmediatamente.", explanation: "'Es crucial que' expresa urgencia y siempre activa el Subjuntivo."},
    {en: "If I were in your place, I would buy the house now before prices go up again.", es: "Si <strong>yo estuviera en tu lugar, comprar√≠a</strong> la casa ahora antes de que los precios suban de nuevo.", explanation: "Estructura condicional para dar consejos hipot√©ticos."},
    {en: "Due to the weather forecast, we suggest that the team cancels the outdoor event.", es: "Debido al pron√≥stico del tiempo, <strong>sugerimos que el equipo cancele</strong> el evento al aire libre.", explanation: "Uso de 'Sugerimos que' + Subjuntivo (Nosotros sugerimos -> El equipo cancela)."}
];

let currentLang = 'en';
let currentCard = 0;
let selectedDragItem = null;

document.addEventListener('DOMContentLoaded', () => {
    // TABS
    window.changeMainTab = function(evt, tabId) {
        document.querySelectorAll('.main-tab-content').forEach(el => el.classList.remove('is-active'));
        document.querySelectorAll('.main-tab-nav button').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('is-active');
        evt.currentTarget.classList.add('active');
        
        if (tabId === 'tab-practica') {
            if(!document.getElementById('quiz-container').hasChildNodes()) generateQuiz();
            if(!document.getElementById('story-container').hasChildNodes()) generateStory();
            if(!document.getElementById('drag-items-pool').hasChildNodes()) generateDragDrop();
        }
        if (tabId === 'tab-bank') renderBank();
        if (tabId === 'tab-flashcards') loadCard();
    }

    // VISUALIZER
    window.showViz = function(btn, trigger, verb_context, verb, mood) {
        document.querySelectorAll('.formula-toggle').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const res = document.getElementById('viz-result');
        const moodClass = mood.includes('Infinitive') ? 'fc-inf' : 'fc-subj';
        const queCard = mood.includes('Infinitive') ? '' : `<div class='formula-card fc-que'>que</div>`;
        
        res.innerHTML = `<div class='formula-card fc-trigger'>${trigger}</div> ${queCard} ${verb_context} <div class='formula-card ${moodClass}'>${verb}</div> ${mood}`;
        speak(trigger + " " + (queCard ? "que " : "") + verb);
    }

    // QUIZ
    document.getElementById('generate-quiz').addEventListener('click', generateQuiz);
    function generateQuiz() {
        const container = document.getElementById('quiz-container');
        container.innerHTML = '';
        const qs = [...quizItems].sort(() => 0.5 - Math.random()).slice(0, 5);
        qs.forEach((q, i) => {
            const cleanQ = q.q.replace(/\(([^)]+)\)/, '___');
            let html = `<div class="quiz-question"><p><strong>${i+1}. ${cleanQ}</strong></p><p style="font-size:0.9em;color:#666; font-style:italic;">${q.context_en}</p><div>`;
            q.options.forEach((opt, idx) => html += `<button onclick="checkQuiz(this, ${idx === q.correct}, '${q.exp}')">${opt}</button>`);
            html += `</div><div class="feedback"></div><div class="explanation-text" style="display:none"></div></div>`;
            container.innerHTML += html;
        });
    }
    window.checkQuiz = function(btn, isCorrect, exp) {
        const p = btn.parentElement.parentElement;
        p.querySelectorAll('button').forEach(b => b.disabled = true);
        const fb = p.querySelector('.feedback');
        const exT = p.querySelector('.explanation-text');
        exT.textContent = exp; exT.style.display = 'block';
        if(isCorrect) { fb.textContent = "Correct! üëç"; fb.className = "feedback correct"; btn.style.background = "var(--green)"; btn.style.color = "white"; }
        else { fb.textContent = "Incorrect üòï"; fb.className = "feedback incorrect"; btn.style.background = "var(--red)"; btn.style.color = "white"; }
    }

    // STORY
    document.getElementById('generate-story').addEventListener('click', generateStory);
    document.getElementById('check-story-btn').addEventListener('click', () => {
        document.querySelectorAll('#story-container select').forEach(s => {
            s.style.backgroundColor = s.value === 'c' ? "#d4edda" : "#f8d7da";
        });
    });
    function generateStory() {
        const s = storyData[Math.floor(Math.random() * storyData.length)];
        document.getElementById('story-container').innerHTML = `<h3>${s.title}</h3>${s.html}`;
    }

    // DRAG DROP
    document.getElementById('generate-drag').addEventListener('click', generateDragDrop);
    function generateDragDrop() {
        const pool = document.getElementById('drag-items-pool');
        const zInf = document.querySelector('#zone-inf .zone-content');
        const zSubj = document.querySelector('#zone-subj .zone-content');
        pool.innerHTML = ''; zInf.innerHTML = ''; zSubj.innerHTML = '';
        document.getElementById('drag-feedback').textContent = '';
        
        dragItemsData.sort(()=>0.5-Math.random()).forEach(item => {
            const el = document.createElement('div');
            el.className = 'draggable';
            el.textContent = item.text;
            el.dataset.type = item.type;
            el.onclick = () => selectDragItem(el);
            pool.appendChild(el);
        });
    }
    
    function selectDragItem(el) {
        if(el.parentElement.classList.contains('zone-content')) return;
        document.querySelectorAll('.draggable').forEach(d => d.classList.remove('selected'));
        el.classList.add('selected');
        selectedDragItem = el;
    }
    
    window.handleDrop = function(zoneType) {
        if(!selectedDragItem) return;
        const correct = selectedDragItem.dataset.type === zoneType;
        const fb = document.getElementById('drag-feedback');
        
        if(correct) {
            selectedDragItem.classList.remove('selected');
            selectedDragItem.style.cursor = 'default';
            selectedDragItem.onclick = null;
            if(zoneType === 'inf') document.querySelector('#zone-inf .zone-content').appendChild(selectedDragItem);
            else document.querySelector('#zone-subj .zone-content').appendChild(selectedDragItem);
            selectedDragItem = null;
            fb.textContent = "Correct! üéâ"; fb.className = "feedback correct";
        } else {
            fb.textContent = "Try again! ‚ùå"; fb.className = "feedback incorrect";
        }
    }

    // BANK
    function renderBank() {
        const c = document.getElementById('bankContainer');
        if(c.children.length > 0) return;
        phraseBankData.forEach(i => {
            const d = document.createElement('div');
            d.className = `verb-card verb-${i.cat}`; d.dataset.cat = i.cat;
            // Bot√≥n "Explain" y Traducci√≥n
            d.innerHTML = `<div class="verb-header"><span class="verb-title">${i.text}</span><div><button class="btn-explain" onclick="showModal('${i.text}','${i.struct}','${i.ex_es}','${i.ex_en}')">Explain</button><span class="tts-icon" data-tts="${i.ex_es}">üîä</span></div></div><p>${i.ex_es}</p>`;
            c.appendChild(d);
        });
    }
    window.filterBank = function(btn, cat) {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.verb-card').forEach(c => c.style.display = (cat === 'all' || c.dataset.cat === cat) ? 'block' : 'none');
    }

    // MODAL
    window.showModal = (t, s, es, en) => {
        document.getElementById('modal-title').textContent = t;
        document.getElementById('modal-struct').textContent = s;
        document.getElementById('modal-ex-es').textContent = es;
        document.getElementById('modal-ex-es').dataset.tts = es; 
        document.getElementById('modal-ex-en').textContent = en; 
        document.getElementById('explain-modal').style.display = 'flex';
    }
    window.closeModal = () => document.getElementById('explain-modal').style.display = 'none';

    // FLASHCARDS & UTILS
    function loadCard() {
        const c = flashcards[currentCard];
        document.getElementById('card-front').innerHTML = c.en;
        document.getElementById('card-back').innerHTML = `${c.es}<br><small>${c.explanation}</small>`;
        document.getElementById('flashcard').classList.remove('is-flipped');
    }
    window.flipCard = () => document.getElementById('flashcard').classList.toggle('is-flipped');
    window.nextCard = () => { currentCard = (currentCard + 1) % flashcards.length; loadCard(); };
    window.prevCard = () => { currentCard = (currentCard - 1 + flashcards.length) % flashcards.length; loadCard(); };
    
    window.toggleLang = () => {
        currentLang = currentLang === 'en' ? 'es' : 'en';
        document.querySelectorAll('[data-lang-key]').forEach(el => {
            if(uiData[currentLang][el.dataset.langKey]) el.innerHTML = uiData[currentLang][el.dataset.langKey];
        });
        loadCard();
    };
    window.toggleTheme = () => document.body.classList.toggle('dark-mode');
    
    window.speak = (txt) => {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(txt); u.lang = 'es-ES';
        window.speechSynthesis.speak(u);
    };
    document.body.addEventListener('click', e => {
        if(e.target.classList.contains('tts-icon')) { e.stopPropagation(); speak(e.target.dataset.tts); }
    });

    loadCard();
});
</script>
</body>
</html>
